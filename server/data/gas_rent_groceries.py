import sqlite3
from lib.config import iso_list, new_york_rent, new_york_salary, new_york_grocery, gas_rent_grocery_api, sqlite_db
import datetime
from helper_class.api_helper import api
from lib.database import database

# get current date (especially interested in the week_number)
current_date = datetime.date.today()
year, week_number, day_of_week = current_date.isocalendar()

# Initialize database
db = database(sqlite_db)

# Create table if it does not exists
db.add_table('financials', country='text', gasoline='text', rent='text', groceries='text')

gasoline_api = f'http://knoema.com/api/1.0/data/GPPW?time=2019W{week_number}&country=1000310,1001270,1001770,1000030,1001630,1000000,1000010,1000040,1000060,1000100,1000090,1000080,1000110,1000210,1000150,1000140,1000170,1000260,1000250,1000130,1000280,1001780,1000200,1000240,1000120,1000190,1000220,1000160,1000180,1001820,1001500,1000760,1000350,1000300,1000360,1000370,1000380,1000400,1000320,1000410,1000420,1000570,1000430,1000440,1000450,1000020,1000460,1000490,1000470,1001420,1000500,1000520,1000510,1000530,1000540,1000550,1000600,1000560,1000580,1000620,1000590,1000610,1000630,1000660,1000650,1000390,1000640,1000670,1000700,1000730,1000740,1000690,1000720,1000710,1000680,1000750,1000770,1000790,1000780,1000810,1000830,1000290,1001410,1000820,1000330,1000800,1000840,1000860,1001310,1000890,1001430,1000880,1000870,1000900,1000910,1000850,1000960,1001040,1001030,1001060,1000930,1000920,1000970,1000270,1000990,1000980,1001000,1000940,1001020,1000950,1001080,1001090,1001150,1001130,1001110,1001160,1001100,1001120,1001170,1001190,1001210,1001220,1001180,1001230,1001250,1001240,1001200,1001260,1001280,1001350,1001290,1001300,1001330,1001460,1001490,1001370,1001390,1001380,1001360,1001320,1001340,1001470,1000480,1001480,1000340,1001450,1001550,1001600,1001580,1001590,1001570,1001520,1001540,1001620,1001610,1001660,1001650,1001670,1001680,1001690,1001840,1001700,1001010,1001400,1001710,1001720,1001800,1000050,1000070,1000230,1001140,1001790,1001530,1001510,1001640,1001070,1001050,1001440,1001560&indicator=1000030&measure=1000000&frequencies=W'
rent_api = 'http://knoema.com/api/1.0/data/COOFLIIND2016?time=&uiMode=last&uiParams=1&country=1000020,1000030,1000040,1000050,1000060,1000070,1000080,1000090,1000120,1000130,1000140,1000150,1000160,1000180,1000190,1000200,1000220,1000230,1000260,1001550,1001530,1000270,1000280,1000290,1000300,1000320,1000330,1000340,1000350,1000360,1000370,1000380,1000390,1000410,1000420,1000430,1000450,1000460,1000470,1000480,1000490,1000500,1000510,1000520,1000530,1000540,1000570,1000580,1000600,1000610,1000620,1000630,1000640,1000650,1000660,1000680,1000690,1000700,1000710,1000720,1000730,1000750,1000760,1000770,1000780,1000790,1000800,1000810,1000820,1000830,1000850,1000860,1000870,1000880,1000890,1000900,1000910,1000920,1000930,1000940,1000950,1000960,1000970,1000980,1000990,1001000,1001010,1001040,1001050,1001060,1001070,1001080,1001090,1001100,1001110,1001120,1001130,1001150,1001160,1001170,1001180,1001190,1001200,1001210,1001220,1001230,1001240,1001260,1001270,1001280,1001290,1001300,1001310,1001320,1001330,1001340,1001350,1001360,1001370,1001380,1001400,1001410,1001420,1001430,1001440,1001450,1001460,1001470,1001490,1001500,1001510&indicator=1000010&frequencies=A'
groceries_api = 'http://knoema.com/api/1.0/data/COOFLIIND2016?time=&uiMode=last&uiParams=1&country=1000820,1000020,1000030,1000040,1000050,1000060,1000070,1000080,1000090,1000120,1000130,1000140,1000150,1000160,1000180,1000190,1000200,1000220,1000230,1000260,1001550,1001530,1000270,1000280,1000290,1000300,1000320,1000330,1000340,1000350,1000360,1000370,1000380,1000390,1000410,1000420,1000430,1000450,1000460,1000470,1000480,1000490,1000500,1000510,1000520,1000530,1000540,1000570,1000580,1000600,1000610,1000620,1000630,1000640,1000650,1000660,1000680,1000690,1000700,1000710,1000720,1000730,1000750,1000760,1000770,1000780,1000790,1000800,1000810,1000830,1000850,1000860,1000870,1000880,1000890,1000900,1000910,1000920,1000930,1000940,1000950,1000960,1000970,1000980,1000990,1001000,1001010,1001040,1001050,1001060,1001070,1001080,1001090,1001100,1001110,1001120,1001130,1001150,1001160,1001170,1001180,1001190,1001200,1001210,1001220,1001230,1001240,1001260,1001270,1001280,1001290,1001300,1001310,1001320,1001330,1001340,1001350,1001360,1001370,1001380,1001400,1001410,1001420,1001430,1001440,1001450,1001460,1001470,1001490,1001500,1001510&indicator=1000030&frequencies=A'

def fincancials_data(api_link, data_type) :
  try:
    api_url = api(api_link)
    json_data = api_url.get_json()['data']
    for i in json_data:
      for country in iso_list:
        try:
          if i['RegionId'] == country:
            data_to_insert = i['Value']
            print('Country:', i['RegionId'], '-> Current', data_type, 'cost:', data_to_insert)
            if data_type == 'gasoline':
              db.insert('financials', str(country), str(data_to_insert), '', '')
            elif data_type == 'rent':
              where_claus = f'country={country}'
              column_value = f'rent={data_to_insert}'
              db.update('financials', table_name, column_value)
            elif data_type == 'groceries':
              where_claus = f'country={country}'
              column_value = f'groceries={data_to_insert}'
              db.update('financials', table_name, column_value)
        except Exception as e:
          print(f'Could not get {data_type} data for {country} because of the following error: {e}')
  except Exception as e:
    print(f'Could not get response from api because of the following error: {e}')

fincancials_data(gasoline_api, 'gasoline')
fincancials_data(rent_api, 'rent')
fincancials_data(groceries_api, 'groceries')
